<!DOCTYPE html>
<html>
  <head>
    <title>MOON GOAT!</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        position: relative;
      }
      #canvas {
        display: block;
        background: black;
      }
      /* Buttons overlay */
      .btn {
        position: fixed;
        bottom: 20px;
        width: 100px;
        height: 60px;
        font-size: 20px;
        color: white;
        background: rgba(0,0,0,0.7);
        border: 2px solid white;
        border-radius: 8px;
        user-select: none;
        touch-action: manipulation;
      }
      #jumpBtn {
        left: 20px;
      }
      #restartBtn {
        right: 20px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="640" height="480"></canvas>
    <button id="jumpBtn" class="btn">Jump</button>
    <button id="restartBtn" class="btn">Restart</button>
    <script>
      var isGameStarted = true;

      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");

      var goatImg = new Image();
      goatImg.src = "moongoatgoat.png";

      function floor(x, height) {
        this.x = x;
        this.width = 700;
        this.height = height;
      }

      var startMenu = {
        height: 480,
        width: 640,
        tick: function () {
          prompt("Now we are here");
          this.draw();
        },
        draw: function () {
          prompt("Now we are in the draw function");
          ctx.fillStyle = "black";
          ctx.fillRect(0, 0, this.width, this.height);
          ctx.fillStyle = "white";
          ctx.font = "28px Arial";
          ctx.fillText("Moon Goat", 200, 200);
          ctx.fillText("Say something else", 200, 250);
        },
      };

      var world = {
        height: 480,
        width: 640,
        gravity: 6,
        highestFloor: 240,
        speed: 5,
        distanceTravelled: 0,
        maxSpeed: 15,
        tilesPassed: 0,
        autoScroll: true,
        floorTiles: [new floor(0, 140)],
        stop: function () {
          this.autoScroll = false;
        },
        moveFloor: function () {
          for (index in this.floorTiles) {
            var tile = this.floorTiles[index];
            tile.x -= this.speed;
            this.distanceTravelled += this.speed;
          }
        },
        tick: function () {
          if (!this.autoScroll) return;
          this.cleanOldTiles();
          this.addFutureTiles();
          this.moveFloor();
        },
        draw: function () {
          ctx.fillStyle = "black";
          ctx.fillRect(0, 0, this.width, this.height);
          for (index in this.floorTiles) {
            var tile = this.floorTiles[index];
            var y = world.height - tile.height;
            ctx.fillStyle = "gray";
            ctx.fillRect(tile.x, y, tile.width, tile.height);
            ctx.fillStyle = "white";
            ctx.font = "28px Arial";
            ctx.fillText("Speed:" + this.speed, 10, 40);
            ctx.fillText("Distance Travelled: " + this.distanceTravelled, 10, 75);
          }
        },
        addFutureTiles: function () {
          if (this.floorTiles.length >= 3) return;
          var previousTile = this.floorTiles[this.floorTiles.length - 1];
          var biggestJumpableHeight = previousTile.height + player.height * 2;
          if (biggestJumpableHeight > this.highestFloor) {
            biggestJumpableHeight = this.highestFloor;
          }
          var randomHeight = Math.floor(Math.random() * biggestJumpableHeight) + player.height;
          var leftValue = previousTile.x + previousTile.width;
          var next = new floor(leftValue, randomHeight);
          this.floorTiles.push(next);
        },
        cleanOldTiles: function () {
          for (index in this.floorTiles) {
            if (this.floorTiles[index].x <= -this.floorTiles[index].width) {
              this.floorTiles.splice(index, 1);
              this.tilesPassed++;
              if (this.tilesPassed % 3 == 0 && this.speed < this.maxSpeed) {
                this.speed++;
              }
            }
          }
        },
        getDistanceToFloor: function (playerX) {
          for (index in this.floorTiles) {
            var tile = this.floorTiles[index];
            if (tile.x <= playerX && tile.x + tile.width >= playerX) {
              return tile.height;
            }
          }
          return -1;
        },
      };

      var player = {
        x: 160,
        y: 340,
        height: 20,
        width: 20,
        velocityY: 0,
        gravity: 0.5,
        jumpImpulse: -10,
        jumpHeight: 0,
        canControl: true,

        jump: function () {
          if (!this.canControl) return;
          var floorHeight = world.getDistanceToFloor(this.x);
          var onTheFloor = this.y >= world.height - floorHeight;
          if (onTheFloor) {
            this.velocityY = this.jumpImpulse;
          }
        },

        keypress: function (keyInfo) {
          if (keyInfo.code === "KeyR") {
            // Reload the page on pressing R
            window.location.reload();
            return;
          }
          if (!this.canControl) return;

          this.jump();
        },

        getDistanceFor: function (x) {
          var platformBelow = world.getDistanceToFloor(x);
          return world.height - this.y - platformBelow;
        },

        applyGravity: function () {
          this.currentDistanceAboveGround = this.getDistanceFor(this.x);
          var rightHandSideDistance = this.getDistanceFor(this.x + this.width);
          if (
            this.currentDistanceAboveGround < 0 ||
            rightHandSideDistance < 0
          ) {
            world.stop();
            this.canControl = false;
          }
        },

        processGravity: function () {
          this.velocityY += this.gravity;
          this.y += this.velocityY;

          var floorHeight = world.getDistanceToFloor(this.x);
          var topYofPlatform = world.height - floorHeight;

          if (this.y > topYofPlatform) {
            this.y = topYofPlatform;
            this.velocityY = 0;
          }
        },

        tick: function () {
          this.processGravity();
          this.applyGravity();
        },

        draw: function () {
          ctx.drawImage(
            goatImg,
            this.x,
            this.y - this.height,
            this.width,
            this.height
          );
        },
      };

      window.addEventListener(
        "keypress",
        function (keyInfo) {
          player.keypress(keyInfo);
        },
        false
      );

      // Mobile buttons
      document.getElementById('jumpBtn').addEventListener('touchstart', function(e) {
        e.preventDefault();  // prevent scrolling
        player.jump();
      });

      document.getElementById('restartBtn').addEventListener('touchstart', function(e) {
        e.preventDefault();
        window.location.reload();
      });

      function tick() {
        if (isGameStarted) {
          player.tick();
          world.tick();
          world.draw();
          player.draw();
          window.setTimeout(tick, 1000 / 60);
        } else {
          prompt("We know we got to here");
          startMenu.tick();
        }
      }

      tick();
    </script>
  </body>
</html>
