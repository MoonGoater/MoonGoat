<!DOCTYPE html>
<html>
<head>
  <title>MOON GOAT!</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      position: relative;
    }
    #canvas {
      display: block;
      background: black;
    }
    .btn {
      position: fixed;
      bottom: 20px;
      width: 100px;
      height: 60px;
      font-size: 20px;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid white;
      border-radius: 8px;
      user-select: none;
      touch-action: manipulation;
    }
    #jumpBtn {
      left: 20px;
    }
    #restartBtn {
      right: 20px;
    }
  </style>
</head>
<body>
  <canvas id="canvas" width="640" height="480"></canvas>
  <button id="jumpBtn" class="btn">Jump</button>
  <button id="restartBtn" class="btn">Restart</button>

<script>
  var isGameStarted = true;
  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext("2d");

  var goatImg = new Image();
  goatImg.src = "moongoatgoat.png";

  // Stars
  var starCount = 100;
  var stars = [];

  function initStars() {
    stars = [];
    for (let i = 0; i < starCount; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        radius: Math.random() * 1.2 + 0.3,
        alpha: Math.random(),
        alphaChange: (Math.random() * 0.02) + 0.005,
      });
    }
  }

  function drawStars() {
    for (let star of stars) {
      star.alpha += star.alphaChange;
      if (star.alpha >= 1 || star.alpha <= 0.2) star.alphaChange *= -1;

      ctx.beginPath();
      ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255,255,255," + star.alpha.toFixed(2) + ")";
      ctx.fill();
    }
  }

  // Shooting stars
  var shootingStars = [];
  var shootingTimer = 0;

  function spawnShootingStar() {
    shootingStars.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height / 2,
      vx: -4 - Math.random() * 2,
      vy: 2 + Math.random() * 2,
      length: 80 + Math.random() * 40,
      alpha: 1,
    });
  }

  function updateShootingStars() {
    shootingTimer++;
    if (shootingTimer > 120 + Math.random() * 100) {
      spawnShootingStar();
      shootingTimer = 0;
    }

    for (let star of shootingStars) {
      star.x += star.vx;
      star.y += star.vy;
      star.alpha -= 0.01;
    }

    shootingStars = shootingStars.filter(s => s.alpha > 0);
  }

  function drawShootingStars() {
    for (let star of shootingStars) {
      const grad = ctx.createLinearGradient(star.x, star.y, star.x + star.length, star.y - star.length / 2);
      grad.addColorStop(0, "rgba(255,255,255," + star.alpha + ")");
      grad.addColorStop(1, "rgba(255,255,255,0)");
      ctx.strokeStyle = grad;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(star.x, star.y);
      ctx.lineTo(star.x + star.length, star.y - star.length / 2);
      ctx.stroke();
    }
  }

  initStars();

  function floor(x, height) {
    this.x = x;
    this.width = 700;
    this.height = height;
  }

  var world = {
    height: 480,
    width: 640,
    gravity: 6,
    highestFloor: 240,
    speed: 5,
    distanceTravelled: 0,
    maxSpeed: 15,
    tilesPassed: 0,
    autoScroll: true,
    floorTiles: [new floor(0, 140)],
    stop: function () {
      this.autoScroll = false;
    },
    moveFloor: function () {
      for (let index in this.floorTiles) {
        var tile = this.floorTiles[index];
        tile.x -= this.speed;
        this.distanceTravelled += this.speed;
      }
    },
    tick: function () {
      if (!this.autoScroll) return;
      this.cleanOldTiles();
      this.addFutureTiles();
      this.moveFloor();
    },
    draw: function () {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, this.width, this.height);

      drawStars();
      updateShootingStars();
      drawShootingStars();

      for (let index in this.floorTiles) {
        var tile = this.floorTiles[index];
        var y = world.height - tile.height;

        ctx.fillStyle = "gray";
        ctx.fillRect(tile.x, y, tile.width, tile.height);

        ctx.fillStyle = "white";
        ctx.font = "28px Arial";
        ctx.fillText("Speed: " + this.speed, 10, 40);
        ctx.fillText("Distance Travelled: " + this.distanceTravelled, 10, 75);
      }
    },
    addFutureTiles: function () {
      if (this.floorTiles.length >= 3) return;
      var previousTile = this.floorTiles[this.floorTiles.length - 1];
      var biggestJumpableHeight = previousTile.height + player.height * 2;
      if (biggestJumpableHeight > this.highestFloor) {
        biggestJumpableHeight = this.highestFloor;
      }

      var minHeightDiff = 20;
      var randomHeight;

      do {
        randomHeight = Math.floor(Math.random() * biggestJumpableHeight) + player.height;
      } while (Math.abs(randomHeight - previousTile.height) < minHeightDiff);

      var leftValue = previousTile.x + previousTile.width;
      var next = new floor(leftValue, randomHeight);
      this.floorTiles.push(next);
    },
    cleanOldTiles: function () {
      for (let index in this.floorTiles) {
        if (this.floorTiles[index].x <= -this.floorTiles[index].width) {
          this.floorTiles.splice(index, 1);
          this.tilesPassed++;
          if (this.tilesPassed % 3 === 0 && this.speed < this.maxSpeed) {
            this.speed++;
          }
        }
      }
    },
    getDistanceToFloor: function (playerX) {
      for (let index in this.floorTiles) {
        var tile = this.floorTiles[index];
        if (tile.x <= playerX && tile.x + tile.width >= playerX) {
          return tile.height;
        }
      }
      return -1;
    },
  };

  var player = {
    x: 160,
    y: 340,
    height: 20,
    width: 20,
    velocityY: 0,
    gravity: 0.5,
    jumpImpulse: -7,          // Reduced jump impulse for lower jump
    maxJumpHoldFrames: 10,    // Reduced max jump hold frames
    jumpHoldCounter: 0,
    jumping: false,
    canControl: true,

    jump: function () {
      if (!this.canControl) return;
      var floorHeight = world.getDistanceToFloor(this.x);
      var onTheFloor = this.y >= world.height - floorHeight;
      if (onTheFloor && !this.jumping) {
        this.velocityY = this.jumpImpulse;
        this.jumping = true;
        this.jumpHoldCounter = 0;
      }
    },

    releaseJump: function () {
      this.jumping = false;
    },

    keypress: function (keyInfo) {
      if (keyInfo.code === "KeyR") {
        window.location.reload();
        return;
      }
      if (keyInfo.code === "Space") {
        this.jump();
      }
    },

    keyup: function (keyInfo) {
      if (keyInfo.code === "Space") {
        this.releaseJump();
      }
    },

    getDistanceFor: function (x) {
      var platformBelow = world.getDistanceToFloor(x);
      return world.height - this.y - platformBelow;
    },

    applyGravity: function () {
      this.currentDistanceAboveGround = this.getDistanceFor(this.x);
      var rightHandSideDistance = this.getDistanceFor(this.x + this.width);
      if (this.currentDistanceAboveGround < 0 || rightHandSideDistance < 0) {
        world.stop();
        this.canControl = false;
      }
    },

    processGravity: function () {
      if (this.jumping && this.jumpHoldCounter < this.maxJumpHoldFrames) {
        this.velocityY += -0.2; // Reduced boost while holding jump
        this.jumpHoldCounter++;
      }

      this.velocityY += this.gravity;
      this.y += this.velocityY;

      var floorHeight = world.getDistanceToFloor(this.x);
      var topYofPlatform = world.height - floorHeight;

      if (this.y > topYofPlatform) {
        this.y = topYofPlatform;
        this.velocityY = 0;
        this.jumping = false;
      }
    },

    tick: function () {
      this.processGravity();
      this.applyGravity();
    },

    draw: function () {
      ctx.drawImage(
        goatImg,
        this.x,
        this.y - this.height,
        this.width,
        this.height
      );
    },
  };

  window.addEventListener("keydown", function (e) {
    player.keypress(e);
  });

  window.addEventListener("keyup", function (e) {
    player.keyup(e);
  });

  document.getElementById('jumpBtn').addEventListener('touchstart', function (e) {
    e.preventDefault();
    player.jump();
  });

  document.getElementById('jumpBtn').addEventListener('touchend', function (e) {
    e.preventDefault();
    player.releaseJump();
  });

  document.getElementById('restartBtn').addEventListener('touchstart', function (e) {
    e.preventDefault();
    window.location.reload();
  });

  function tick() {
    if (isGameStarted) {
      player.tick();
      world.tick();
      world.draw();
      player.draw();
      requestAnimationFrame(tick);
    }
  }

  tick();
</script>

</body>
</html>
